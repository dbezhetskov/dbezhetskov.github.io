<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
</head>

<body>
    <input type="file" id="input-wasm" />
    <div style="text-align:center;">
        <canvas id="memory-canvas" width="800" height="100" style="border:1px solid #000000;"></canvas>
    </div>
    <script>
        const canvasContext = document.getElementById("memory-canvas").getContext('2d');

        const inputElement = document.getElementById("input-wasm");
        inputElement.addEventListener("change", handleFile, false);
        function handleFile() {
            const wasmFile = this.files[0];
            const wasmURL = window.URL.createObjectURL(wasmFile);
            initializeWasm(wasmURL).then(main);
        }

        async function initializeWasm(wasmURL) {
            const fetchPromise = fetch(wasmURL);
            const imports = {
                wasi_snapshot_preview1: {
                    proc_exit: console.log,
                    fd_write: console.log,
                    clock_time_get: console.log,
                    clock_res_get: console.log,
                    fd_filestat_get: console.log,
                    fd_readdir: console.log,
                    fd_close: console.log,
                    fd_write: console.log,
                    fd_seek: console.log,
                    fd_read: console.log,
                    fd_fdstat_get: console.log,
                    path_open: console.log,
                    path_unlink_file: console.log,
                    path_remove_directory: console.log,
                    environ_sizes_get: console.log,
                    environ_get: console.log,
                    args_sizes_get: console.log,
                    args_get: console.log,
                    fd_prestat_get: console.log,
                    fd_prestat_dir_name: console.log,
                    fd_fdstat_set_flags: console.log
                }
            };
            const { instance } = await WebAssembly.instantiateStreaming(fetchPromise, imports);
            return instance;
        }

        function isPageDirt(page) {
            for (let i = 0; i < page.length; ++i) {
                if (page[i] != 0x00) {
                    return false;
                }
            }

            return true;
        }

        function main(instance) {
            const memoryBuffer = instance.exports.memory.buffer;
            const kPageSize = 2 ** 16;
            const numOfPages = memoryBuffer.byteLength / kPageSize;

            for (let pageId = 0; pageId < numOfPages; ++pageId) {
                let pageOffset = pageId * kPageSize;
                let page = new Uint8Array(memoryBuffer, pageOffset, kPageSize);
                if (isPageDirt(page)) {
                    console.log(1);
                } else {
                    console.log(0);
                }
            }
        }
    </script>
</body>

</html>